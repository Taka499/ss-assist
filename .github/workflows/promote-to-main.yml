name: Promote develop to main

on:
  pull_request:
    types: [closed]
    branches: [develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  promote:
    # Only run when an auto-sync PR is merged (not closed without merging)
    if: >-
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'auto/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Create or update PR to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE_PR: ${{ github.event.pull_request.number }}
        run: |
          EXISTING=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING" ]; then
            echo "PR #$EXISTING already exists — it now includes changes from #$SOURCE_PR"
          else
            cat > /tmp/pr-body.md <<EOF
          ## Auto-created after merging auto-sync PR

          Triggered by #${SOURCE_PR}.

          Merging this PR will deploy the latest data to GitHub Pages.

          ### Checklist
          - [ ] Spot-check the app works correctly on dev
          - [ ] Verify new character icons look correct
          EOF
            gh pr create \
              --base main \
              --head develop \
              --title "release: promote develop to main" \
              --body-path /tmp/pr-body.md
            echo "Created new PR: develop → main"
          fi
